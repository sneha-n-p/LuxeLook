<!-- ADMIN HEADER -->
<%-include("../../views/partials/adminPartial/header")%>

  <!-- TAILWIND CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <body class="bg-[#0f172a] text-white min-h-screen flex justify-center px-4 py-10">

    <div class="w-full max-w-4xl bg-[#1e293b] p-8 md:p-12 rounded-2xl shadow-2xl">

      <!-- Back Button -->
      <button onclick="window.history.back()"
        class="mb-6 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded flex items-center gap-2">
        â¬… Go Back
      </button>

      <h1 class="text-2xl md:text-3xl font-semibold mb-6">Add Product</h1>

      <form id="add-productForm" action="/admin/Products/add-product" method="POST" enctype="multipart/form-data"
        class="space-y-6">

        <!-- GRID FIRST ROW -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

          <!-- Product Name -->
          <div>
            <label class="block font-medium mb-1">Product Name</label>
            <p id="name-error" class="text-red-400 text-sm"></p>
            <input type="text" id="name" name="ProductName"
              class="w-full p-3 rounded bg-white text-black outline-none focus:ring-2 focus:ring-cyan-400"
              maxlength="100" />
          </div>

          <!-- Product Category -->
          <div>
            <label class="block font-medium mb-1">Category</label>
            <p id="category-error" class="text-red-400 text-sm"></p>
            <select id="category" name="category"
              class="w-full p-3 rounded bg-white text-black outline-none focus:ring-2 focus:ring-cyan-400">
              <option value="" disabled selected>Select Category</option>
              <% categories.forEach(category=> { %>
                <option value="<%= category.name %>">
                  <%= category.name %>
                </option>
                <% }) %>
            </select>
          </div>

          <!-- Description -->
          <div class="md:col-span-2">
            <label class="block font-medium mb-1">Description</label>
            <p id="description-error" class="text-red-400 text-sm"></p>
            <textarea id="description" name="description" rows="3"
              class="w-full p-3 rounded bg-white text-black outline-none focus:ring-2 focus:ring-cyan-400"
              maxlength="150"></textarea>
          </div>

          <!-- Offer -->
          <div>
            <label class="block font-medium mb-1">Offer (%)</label>
            <p id="offer-error" class="text-red-400 text-sm"></p>
            <input type="number" id="offer" name="offer"
              class="w-full p-3 rounded bg-white text-black outline-none focus:ring-2 focus:ring-cyan-400"
              placeholder="Optional" />
          </div>

          <!-- Price -->
          <div>
            <label class="block font-medium mb-1">Price</label>
            <p id="price-error" class="text-red-400 text-sm"></p>
            <input type="number" id="price" name="price"
              class="w-full p-3 rounded bg-white text-black outline-none focus:ring-2 focus:ring-cyan-400"
              placeholder="Greater than Sale Price" />
          </div>

        </div>

        <!-- VARIANT SECTION -->
        <div>
          <label class="block font-medium mb-2">Product Variants</label>

          <div id="variant-container" class="space-y-3">

            <!-- ONE DEFAULT VARIANT ROW -->
            <div class="grid grid-cols-3 gap-3 items-center">
              <div>
                <input type="text" name="variantSize[]" placeholder="Size"
                  class="w-full p-3 rounded bg-white text-black outline-none">
              </div>

              <div>
                <input type="number" name="variantSalePrice[]" placeholder="Sale Price"
                  class="w-full p-3 rounded bg-white text-black outline-none">
              </div>

              <div class="flex items-center gap-2">
                <input type="number" name="variantQuantity[]" placeholder="Qty"
                  class="w-full p-3 rounded bg-white text-black outline-none">

                </div>
                <button type="button" onclick="removeVariant(this)"
                  class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
                  âœ–
                </button>
            </div>

          </div>

          <button type="button" onclick="addVariant()"
            class="mt-3 bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded">
            + Add Variant
          </button>
        </div>

        <!-- IMAGES -->
        <div>
          <label class="block font-medium mb-3">Product Images (4)</label>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">

            <% for (let i=1; i<=4; i++) { %>
              <div class="border border-gray-600 rounded p-4">
                <label class="block mb-2 font-medium">Image <%= i %></label>

                <input type="file" name="image<%= i %>" id="image<%= i %>"
                  class="w-full text-white file:bg-cyan-500 file:px-4 file:py-2 file:rounded" accept=".jpg,.jpeg,.png"
                  onchange="previewImage(event, <%= i %>)" />

                <!-- Preview before crop -->
                <img id="preview<%= i %>" class="hidden mt-3 w-32 h-32 object-cover rounded shadow" />

                <!-- Cropped Image Output Container (required) -->
                <div class="croppedPreview<%= i %> mt-3"></div>

                <button type="button" onclick="cropImage(<%= i %>)"
                  class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded">
                  Save Image <%= i %>
                </button>
              </div>

              <% } %>

          </div>
        </div>

        <!-- SUBMIT BUTTON -->
        <button type="submit"
          class="w-full bg-cyan-400 hover:bg-cyan-300 text-black font-semibold py-3 rounded-lg text-lg">
          ADD PRODUCT
        </button>
      </form>

    </div>

  </body>


  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css">
  <script src="https://unpkg.com/sweetalert2@11"></script>

  <script>
    let variantCount = 0;

    function clearErrorMessages() {
      const errorElements = document.querySelectorAll(".error-message");
      errorElements.forEach((el) => {
        el.textContent = "";
        el.style.display = "none";
      });
    }

    function displayErrorMessage(elementId, message) {
      const errorElement = document.getElementById(elementId);
      console.log(errorElement)
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = "block";
      }
    }

    function validateForm() {
      clearErrorMessages();
      let isValid = true;

      const name = document.getElementById("name").value.trim();
      console.log(name)
      const description = document.getElementById("description").value.trim();
      const category = document.getElementById("category").value;
      const offer = document.getElementById("offer").value.trim();
      const price = document.getElementById("price").value.trim();
      // const salesPrice = document.getElementById("salesPrice").value.trim();

      const namePattern = /^[A-Za-z ,.-]+$/;
      const numberPattern = /^\d+(\.\d{1,2})?$/;

      if (!name) {
        displayErrorMessage("name-error", "Product name is required");
        isValid = false;
      } else if (!namePattern.test(name)) {
        displayErrorMessage("name-error", "Only alphabets and spaces allowed");
        isValid = false;
      }

      if (!description) {
        displayErrorMessage("description-error", "Description is required");
        isValid = false;
      } else if (!namePattern.test(description)) {
        displayErrorMessage("description-error", "Only alphabets and spaces allowed");
        isValid = false;
      }
      if (!category) {
        displayErrorMessage("category-error", "Please select a category");
        isValid = false;
      }
      if (offer) {
        const numOffer = parseInt(offer);
        if (isNaN(numOffer) || numOffer < 0 || numOffer > 99) {
          displayErrorMessage("offer-error", "Offer must be a number between 0 and 99");
          isValid = false;
        }
      }

      if (!price) {
        displayErrorMessage("price-error", "Price is required");
        isValid = false;
      } else if (!numberPattern.test(price) || parseFloat(price) <= 0) {
        displayErrorMessage("price-error", "Enter a valid price greater than 0");
        isValid = false;
      }

      // if (!salesPrice) {
      //   displayErrorMessage("salesPrice-error", "Sales price is required");
      //   isValid = false;
      // } else if (!numberPattern.test(salesPrice) || parseFloat(salesPrice) <= 0) {
      //   displayErrorMessage("salesPrice-error", "Enter a valid sales price greater than 0");
      //   isValid = false;
      // }

      // if (price && salesPrice && parseFloat(price) <= parseFloat(salesPrice)) {
      //   displayErrorMessage("salesPrice-error", "Price must be greater than sales price");
      //   isValid = false;
      // }

      // Variant validations
      const variantSizes = document.getElementsByName("variantSize[]");
      const variantSalePrices = document.getElementsByName("variantSalePrice[]");
      const variantQuantities = document.getElementsByName("variantQuantity[]");

      for (let i = 0; i < variantSizes.length; i++) {
        const size = variantSizes[i].value.trim();
        const salePrice = variantSalePrices[i].value.trim();
        const quantity = variantQuantities[i].value.trim();

        if (!size) {
          displayErrorMessage(`variantSize-error-${i}`, "Size is required");
          isValid = false;
        }
        if (!salePrice || !numberPattern.test(salePrice) || parseFloat(salePrice) <= 0) {
          displayErrorMessage(`variantSalePrice-error-${i}`, "Valid sale price required");
          isValid = false;
        }
        if (!quantity || isNaN(quantity) || parseInt(quantity) < 0) {
          displayErrorMessage(`variantQuantity-error-${i}`, "Valid quantity required");
          isValid = false;
        }
      }

      let imageUploaded = false;
      for (let i = 1; i <= 4; i++) {
        const croppedPreview = document.querySelector(`.croppedPreview${i} img`);
        if (croppedPreview && croppedPreview.src) {
          imageUploaded = true;
          break;
        }
      }
      if (!imageUploaded) {
        displayErrorMessage("image1-error", "Please upload and crop at image");
        isValid = false;
      }

      return isValid;
    }


    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("add-productForm")
      form.addEventListener("submit", async function (event) {
        event.preventDefault();

        if (validateForm()) {
          const formData = new FormData(form);

          for (let i = 1; i <= 4; i++) {
            const croppedInput = document.getElementById(`cropped-image-${i}`);
            if (croppedInput && croppedInput.value) {
              formData.delete(`image${i}`);
              const blob = dataURLtoBlob(croppedInput.value);
              formData.append(`image${i}`, blob, `cropped-${Date.now()}-${i}.jpg`);
            }
          }

          try {
            const resp = await axios.post("/admin/Products/add-product", formData, {
              headers: { "Content-Type": "multipart/form-data" },
            });

            const data = resp.data;
            if (data.success) {
              Swal.fire({
                title: "Success!",
                text: data.message,
                icon: "success",
                confirmButtonText: "OK",
              }).then(() => {
                window.location.href = data.url;
              });
            } else {
              Swal.fire({
                title: "Error!",
                text: data.message || "Something went wrong",
                icon: "error",
                confirmButtonText: "OK",
              });
            }
          } catch (err) {
            console.error("Axios Error:", err);
            Swal.fire({
              title: "Error!",
              text: "Failed to add product. Please try again.",
              icon: "error",
              confirmButtonText: "OK",
            });
          }
        } else {
          // ðŸ”¹ Add this else block
          Swal.fire({
            icon: "warning",
            title: "Invalid Form",
            text: "Please correct the highlighted errors before submitting.",
            confirmButtonText: "OK",
          });
        }
      });

    });

    function dataURLtoBlob(dataURL) {
      const arr = dataURL.split(",");
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }

    let croppers = [];
    function previewImage(event, index) {
      const input = event.target;
      const file = input.files[0];

      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];

      if (file) {
        if (!allowedTypes.includes(file.type)) {
          displayErrorMessage(`image${index}-error`, "Only JPG, JPEG, and PNG images are allowed");
          input.value = '';
          const preview = document.getElementById(`preview${index}`);
          preview.style.display = 'none';
          if (croppers[index]) {
            croppers[index].destroy();
            croppers[index] = null;
          }
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById(`preview${index}`);
          if (!preview) {
            console.error(`Preview element for index ${index} not found.`);
            return;
          }

          preview.src = e.target.result;
          preview.style.display = "block";

          preview.onload = function () {
            try {
              if (croppers[index]) {
                croppers[index].destroy();
              }
              croppers[index] = new Cropper(preview, {
                aspectRatio: 1,
                viewMode: 1,
                autoCropArea: 0.8,
                movable: true,
                zoomable: true,
                scalable: true,
                rotatable: true,
                ready: function () {
                  console.log(`Cropper initialized for image ${index}`);
                },
              });
            } catch (error) {
              console.error(`Error initializing Cropper for image ${index}:`, error);
              displayErrorMessage(`image${index}-error`, "Failed to initialize image cropper");
            }
          };

          preview.onerror = function () {
            console.error(`Error loading image for preview${index}`);
            displayErrorMessage(`image${index}-error`, "Failed to load the image for cropping");
          };
        };
        reader.readAsDataURL(file);
      }
    }

    function cropImage(index) {
      if (!croppers[index]) {
        displayErrorMessage(`image${index}-error`, "Please select an image first");
        return;
      }

      try {
        const canvas = croppers[index].getCroppedCanvas({
          width: 600,
          height: 600,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: "high",
        });

        if (!canvas) {
          throw new Error("Failed to crop the image.");
        }

        const croppedImageUrl = canvas.toDataURL("image/jpeg", 0.9);

        const croppedPreviewContainer = document.querySelector(`.croppedPreview${index}`);

        if (!croppedPreviewContainer) {
          console.error(`Container .croppedPreview${index} not found`);
          return;
        }

        croppedPreviewContainer.innerHTML = "";

        const croppedPreview = document.createElement("img");
        croppedPreview.className = "cropped-preview";
        croppedPreview.src = croppedImageUrl;
        croppedPreview.style.display = "block";
        croppedPreview.setAttribute("data-image-url", croppedImageUrl);

        croppedPreviewContainer.appendChild(croppedPreview);

        let hiddenInput = document.getElementById(`cropped-image-${index}`);
        if (!hiddenInput) {
          hiddenInput = document.createElement("input");
          hiddenInput.type = "hidden";
          hiddenInput.id = `cropped-image-${index}`;
          hiddenInput.name = `croppedImage${index}`;
          document.getElementById("add-productForm").appendChild(hiddenInput);
        }
        hiddenInput.value = croppedImageUrl;

        croppers[index].destroy();
        croppers[index] = null

        Swal.fire({
          title: "Success!",
          text: "Image cropped successfully.",
          icon: "success",
          confirmButtonText: "OK",
        });
      } catch (error) {
        console.error(`Error cropping image ${index}:`, error);
        displayErrorMessage(`image${index}-error`, "Failed to crop the image");
      }
    }

    function addVariant() {
      variantCount++;

      const container = document.getElementById("variant-container");

      const variantRow = document.createElement("div");
      variantRow.className = "grid grid-cols-3 gap-3 items-center";

      variantRow.innerHTML = `
    <div>
      <input 
        type="text" 
        name="variantSize[]" 
        placeholder="Size"
        class="w-full p-3 rounded bg-white text-black outline-none"
      >
    </div>

    <div>
      <input 
        type="number" 
        name="variantSalePrice[]" 
        placeholder="Sale Price"
        class="w-full p-3 rounded bg-white text-black outline-none"
      >
    </div>

    <div>
      <input 
        type="number" 
        name="variantQuantity[]" 
        placeholder="Qty"
        class="w-full p-3 rounded bg-white text-black outline-none"
      >
      </div>
      <button 
        type="button" 
        onclick="removeVariant(this)"
        class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded"
      >
        âœ–
      </button>

  `;

      container.appendChild(variantRow);
    }


    function removeVariant(btn) {
      btn.parentElement.remove();
    }
  </script>
<%- include("../../views/partials/adminPartial/header") %>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
    /* Desktop Sidebar Offset */
    .main-wrap {
        display: flex;
        min-height: 100vh;
        background-color: #1e1e2f;
        padding-left: 220px;
    }

    /* Fix sidebar for laptop */
    .sidebar {
        width: 220px;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        background: #111827;
    }

    /* Mobile: remove sidebar offset */
    @media (max-width:1024px) {
        .main-wrap {
            padding-left: 0 !important;
        }
    }
</style>

<div class="main-wrap">
<section class="content-main w-full min-h-screen p-6 bg-[#1c1c24] text-white flex justify-center">

    <div class="w-full max-w-xl">

        <!-- HEADER -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold">Edit Coupon</h2>
            <button onclick="window.history.back()" class="bg-gray-700 px-4 py-2 rounded hover:bg-gray-600 text-white">
                â¬… Go Back
            </button>
        </div>

        <!-- FORM CARD -->
        <div class="bg-white text-black rounded-2xl shadow-xl p-6">

            <form method="post" id="coupon-form">

                <input type="hidden" id="coupon-id" name="couponId" value="<%= findCoupon._id %>">

                <!-- Coupon Name -->
                <div class="mb-4">
                    <label class="font-medium">Coupon Name</label>
                    <input type="text" name="couponName" id="coupon-name"
                        value="<%= findCoupon.name %>"
                        class="w-full border p-2 rounded mt-1">
                    <p id="error-coupon-name" class="text-red-500 text-sm"></p>
                </div>

                <!-- Start Date -->
                <div class="mb-4">
                    <label class="font-medium">Start Date</label>
                    <input type="date" name="startDate" id="startingDate"
                        value="<%= findCoupon.createdOn %>"
                        class="w-full border p-2 rounded mt-1">
                    <p id="error-start-date" class="text-red-500 text-sm"></p>
                </div>

                <!-- End Date -->
                <div class="mb-4">
                    <label class="font-medium">End Date</label>
                    <input type="date" name="endDate" id="expiringDate"
                        value="<%= findCoupon.expiredOn %>"
                        class="w-full border p-2 rounded mt-1">
                    <p id="error-end-date" class="text-red-500 text-sm"></p>
                </div>

                <!-- Offer Price -->
                <div class="mb-4">
                    <label class="font-medium">Offer Price</label>
                    <input type="text" name="offerPrice" id="offer-price"
                        value="<%= findCoupon.offerPrice %>"
                        class="w-full border p-2 rounded mt-1">
                    <p id="error-offer-price" class="text-red-500 text-sm"></p>
                </div>

                <!-- Minimum Price -->
                <div class="mb-4">
                    <label class="font-medium">Minimum Price</label>
                    <input type="text" name="minimumPrice" id="minimum-price"
                        value="<%= findCoupon.minimumPrice %>"
                        class="w-full border p-2 rounded mt-1">
                    <p id="error-minimum-price" class="text-red-500 text-sm"></p>
                </div>

                <!-- Submit Button -->
                <button type="submit"
                    class="w-full bg-indigo-600 py-2 rounded text-white hover:bg-indigo-700 mt-4">
                    Update Coupon
                </button>

            </form>
        </div>
    </div>

</section>
</div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function setDefaultStartDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      document.getElementById('startingDate').value = `${year}-${month}-${day}`;
    }

    function setDefaultEndDate() {
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);
      const year = tomorrow.getFullYear();
      const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
      const day = String(tomorrow.getDate()).padStart(2, '0');
      document.getElementById('expiringDate').value = `${year}-${month}-${day}`;
    }

    function validateForm() {
      document.querySelectorAll(".error-message").forEach((element) => (element.innerHTML = ""));
      const sDate = document.getElementById("startingDate").value;
      const eDate = document.getElementById("expiringDate").value;
      const sDateObj = new Date(sDate);
      const eDateObj = new Date(eDate);
      const todayDateObj = new Date();
      todayDateObj.setHours(0, 0, 0, 0);

      if (sDateObj > eDateObj) {
        document.getElementById("error-end-date").innerHTML = "End Date should be after the Start Date";
        return false;
      }

      if (sDateObj < todayDateObj) {
        document.getElementById("error-start-date").innerHTML = "Start Date should be today or later";
        return false;
      }

      const name = document.getElementById("coupon-name").value;
      const nameRegex = /^[A-Za-z0-9 ]{1,50}$/;
      if (!nameRegex.test(name)) {
        document.getElementById("error-coupon-name").innerHTML = "Coupon name must be alphanumeric (max 50 characters)";
        return false;
      }

      const offerPrice = parseInt(document.getElementById("offer-price").value.trim());
      const minimumPrice = parseInt(document.getElementById("minimum-price").value.trim());

      if (isNaN(offerPrice) || isNaN(minimumPrice)) {
        document.getElementById("error-offer-price").innerHTML = "Enter valid numbers for prices";
        return false;
      }

      if (offerPrice >= minimumPrice) {
        document.getElementById("error-offer-price").innerHTML = "Offer price must be less than minimum price";
        return false;
      }

      return true;
    }

    async function updateCoupon() {
      try {
        const response = await axios.patch('/admin/Coupons/updateCoupon', {
          couponId: document.getElementById("coupon-id").value,
          couponName: document.getElementById("coupon-name").value,
          startDate: document.getElementById("startingDate").value,
          endDate: document.getElementById("expiringDate").value,
          offerPrice: document.getElementById("offer-price").value,
          minimumPrice: document.getElementById("minimum-price").value,
        },{validateStatus:(status)=>status!==500});
        console.log("response", response)
        if(response.data.success){
          Swal.fire({
            icon: "success",
            title: "Success",
            text: response.data.message,
            confirmButtonText: "OK"
          }).then(() => {
            window.location.href = "/admin/Coupons";
          });
        }else{
          Swal.fire({
            icon:'error',
            title:'Error',
            text:response.data.message
          })
        }
      } catch (error) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Failed to update the coupon. Please try again!",
          confirmButtonText: "OK",
        });
        console.error("Error updating coupon:", error);
      }
    }

    document.getElementById('coupon-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      if (validateForm()) {
        await updateCoupon();
      }
    });

    window.onload = () => {
      if (!document.getElementById('startingDate').value) setDefaultStartDate();
      if (!document.getElementById('expiringDate').value) setDefaultEndDate();
    };
  </script>
<%- include("../../views/partials/adminPartial/header") %>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
    /* DESKTOP layout (table visible, cards hidden) */
    @media (min-width: 1024px) {
        .desktop-table {
        display: block;
        padding: 0; 
    }
    .mobile-card {
        display: none;
    }
    }

    /* MOBILE layout (table hidden, cards visible) */
    @media (max-width: 1023px) {
        .desktop-table {
            display: none;
        }
        .mobile-card {
            display: block;
        }

        .main-content {
            margin-left: 0 !important;
            padding: 20px !important;
        }
    }

    .main-content {
        margin-left: 220px;
        padding: 40px;
        background-color: #0f172a;
        color: white;
    }
</style>

<body class="bg-[#0f172a] text-white">

<div class="main-content">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-semibold">Sales Report</h2>
        <button onclick="window.history.back()" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-500">
            ⬅ Go Back
        </button>
    </div>

    <!-- FILTERS / FORM CENTERED -->
    <form action="/admin/sales" method="GET" 
          id="sales-filter-form"
          class="bg-[#1e293b] p-4 rounded-lg max-w-6xl mx-auto flex flex-wrap items-center gap-4 text-white">

        <div class="flex flex-col">
            <label class="text-sm">Report Type</label>
            <select name="reportType" id="report-type"
                class="bg-[#334155] px-3 py-2 rounded text-white">
                <option value="daily" <%=(reportType || 'daily' )==='daily' ? 'selected' : '' %>>Daily</option>
                <option value="weekly" <%=reportType==='weekly' ? 'selected' : '' %>>Weekly</option>
                <option value="monthly" <%=reportType==='monthly' ? 'selected' : '' %>>Monthly</option>
                <option value="yearly" <%=reportType==='yearly' ? 'selected' : '' %>>Yearly</option>
                <option value="custom" <%=reportType==='custom' ? 'selected' : '' %>>Custom</option>
            </select>
        </div>

        <!-- Custom Date Range -->
        <div id="custom-date-range" class="hidden flex-wrap gap-3 w-full lg:w-auto">
            <div class="flex flex-col">
                <label class="text-sm">Start Date</label>
                <input type="date" name="startDate" id="start-date"
                    class="bg-[#334155] px-3 py-2 rounded text-white" />
            </div>

            <div class="flex flex-col">
                <label class="text-sm">End Date</label>
                <input type="date" name="endDate" id="end-date"
                    class="bg-[#334155] px-3 py-2 rounded text-white" />
            </div>
        </div>

        <button type="submit" class="bg-green-600 px-4 py-2 rounded hover:bg-green-500">
            Generate Report
        </button>

        <a href="/admin/sales" class="bg-red-600 px-4 py-2 rounded hover:bg-red-500 text-white">
            Clear
        </a>
    </form>

    <!-- REPORT SUMMARY -->
    <% if (salesData) { %>
    <div class="bg-white text-black p-4 rounded-lg mt-6 max-w-6xl mx-auto">
        <p><strong>Overall Sales Count:</strong> <%= salesData.totalSales %></p>
        <p><strong>Overall Order Amount:</strong> Rs.<%= salesData.totalAmount %></p>
        <p><strong>Overall Discount:</strong> Rs.<%= salesData.totalDiscount.toFixed(2) %></p>
    </div>

    <!-- DESKTOP TABLE -->
<div class="desktop-table mt-6 overflow-x-auto max-w-6xl mx-auto rounded-xl shadow-lg">
    <table class="w-full bg-white text-black border-collapse">

        <thead class="bg-[#1c2b45] text-white">
            <tr>
                <th class="py-3 px-4 text-left">User Name</th>
                <th class="py-3 px-4 text-left">Date</th>
                <th class="py-3 px-4 text-left">Order ID</th>
                <th class="py-3 px-4 text-left">Amount</th>
                <th class="py-3 px-4 text-left">Discount</th>
                <th class="py-3 px-4 text-left">Coupon Used</th>
            </tr>
        </thead>

        <tbody>
            <% salesData.orders.forEach(order => { %>
            <tr class="border-b hover:bg-gray-100 transition">
                <td class="py-3 px-4"><%= order.userName %></td>
                <td class="py-3 px-4"><%= order.createdOn.toDateString() %></td>
                <td class="py-3 px-4"><%= order.orderId %></td>
                <td class="py-3 px-4">Rs.<%= order.finalAmount.toFixed(2) %></td>
                <td class="py-3 px-4">Rs.<%= order.discount.toFixed(2) %></td>
                <td class="py-3 px-4"><%= order.couponApplied || 'N/A' %></td>
            </tr>
            <% }) %>
        </tbody>

    </table>
</div>


    <!-- MOBILE CARD VIEW (OPTION B — Highlighted Card UI) -->
    <div class="mobile-card mt-6 space-y-4">
        <% salesData.orders.forEach(order => { %>

        <div class="bg-[#1e293b] border border-[#334155] rounded-xl p-4 shadow-xl text-white">

            <p class="text-lg font-bold text-cyan-300 mb-3">
                <%= order.userName %>
            </p>

            <div class="space-y-1 text-gray-300">
                <p><strong>Date:</strong> <%= order.createdOn.toDateString() %></p>
                <p><strong>Order ID:</strong> <%= order.orderId %></p>
                <p><strong>Amount:</strong> Rs.<%= order.finalAmount %></p>
                <p><strong>Discount:</strong> Rs.<%= order.discount %></p>
                <p><strong>Coupon Used:</strong> <%= order.couponApplied || 'N/A' %></p>
            </div>

        </div>

        <% }) %>
    </div>

    <!-- PAGINATION -->
    <div class="flex justify-between items-center mt-6">
        <p>Showing <%= currentPage %> of <%= totalPage %></p>

        <div class="flex items-center gap-2">
            <a href="?page=<%= currentPage-1 %>&<%= queryParams %>"
               class="px-3 py-1 bg-gray-700 rounded text-white
               <%= currentPage==1 ? 'opacity-40 pointer-events-none':'' %>">‹</a>

            <span class="px-4 py-1 bg-blue-600 rounded text-white"><%= currentPage %></span>

            <a href="?page=<%= currentPage+1 %>&<%= queryParams %>"
               class="px-3 py-1 bg-gray-700 rounded text-white
               <%= currentPage==totalPage ? 'opacity-40 pointer-events-none':'' %>">›</a>
        </div>
    </div>

    <!-- DOWNLOAD BUTTONS -->
    <div class="flex gap-4 mt-6">
        <button onclick="downloadPDF()" class="bg-cyan-400 text-black px-4 py-2 rounded hover:bg-cyan-300">Download PDF</button>
        <button onclick="downloadExcel()" class="bg-cyan-400 text-black px-4 py-2 rounded hover:bg-cyan-300">Download Excel</button>
    </div>

    <% } %>

</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');

      const today = new Date().toISOString().split("T")[0];

      startDateInput.max = today;
      endDateInput.max = today;

      startDateInput.addEventListener('change', function () {
        const startDate = this.value;
        if (startDate) {
          endDateInput.min = startDate;
          if (endDateInput.value && endDateInput.value < startDate) {
            endDateInput.value = '';
          }
        } else {
          endDateInput.removeAttribute('min');
        }
      });

      endDateInput.addEventListener('change', function () {
        const endDate = this.value;
        if (endDate) {
          startDateInput.max = endDate;
          if (startDateInput.value && startDateInput.value > endDate) {
            startDateInput.value = '';
          }
        } else {
          startDateInput.max = today;
        }
      });
      const reportType = document.getElementById('report-type');
      const customDateRange = document.getElementById('custom-date-range');

      reportType.addEventListener('change', function () {
        customDateRange.style.display = this.value === 'custom' ? 'flex' : 'none';
      });

      function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text('Sales Report', 105, 20, { align: 'center' });

        const summary = document.querySelector('.report-summary');
        if (summary) {
          doc.setFontSize(12);
          doc.setTextColor(60, 60, 60);
          doc.text(
            `Overall Sales Count: ${summary.children[0].textContent.split(':')[1].trim() || 0}`,
            14,
            35
          );
          doc.text(
            `Overall Order Amount: ${summary.children[1].textContent.split(': ')[1] || '0'}`,
            14,
            42
          );
          doc.text(
            `Overall Discount: ${summary.children[2].textContent.split(': ')[1] || '0'}`,
            14,
            49
          );
        }

        const table = document.querySelector('.sales-table');
        const rows = [];
        const headers = ['User Name', 'Date', 'Order ID', 'Amount', 'Discount', 'Coupon Used'];

        table.querySelectorAll('tbody tr').forEach(row => {
          const rowData = [];
          row.querySelectorAll('td').forEach(cell => {
            rowData.push(cell.textContent.trim().replace(/\s+/g, ' '));
          });
          rows.push(rowData);
        });

        doc.autoTable({
          head: [headers],
          body: rows,
          startY: 60,
          theme: 'grid',
          styles: {
            fontSize: 9,
            cellPadding: { top: 3, right: 3, bottom: 3, left: 3 },
            valign: 'middle',
            lineColor: [220, 220, 220],
            lineWidth: 0.2,
          },
          headStyles: {
            fillColor: [28, 43, 69],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            halign: 'center',
            valign: 'middle',
          },
          bodyStyles: {
            textColor: [50, 50, 50],
          },
          alternateRowStyles: {
            fillColor: [245, 247, 250],
          },
          columnStyles: {
            0: { halign: 'left', cellWidth: 35 },
            1: { halign: 'center', cellWidth: 28 },
            2: { halign: 'center', cellWidth: 45 },
            3: { halign: 'right', cellWidth: 25 },
            4: { halign: 'right', cellWidth: 25 },
            5: { halign: 'center', cellWidth: 30 },
          },
          margin: { left: 14, right: 14 },
        });

        doc.save('sales-report.pdf');
      }


      function downloadExcel() {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet([]);

        const summary = document.querySelector('.report-summary');
        if (summary) {
          XLSX.utils.sheet_add_aoa(ws, [
            ['Summary'],
            ['Overall Sales Count', summary.children[0].textContent.split(':')[1].trim() || ''],
            ['Overall Order Amount', summary.children[1].textContent.split(': ')[1] || ''],
            ['Overall Discount', summary.children[2].textContent.split(': ')[1] || ''],
            [''],
          ], { origin: 'A1' });
        }

        const table = document.querySelector('.sales-table');
        if (table) {
          const headers = ['User Name', 'Date', 'Order ID', 'Amount', 'Discount', 'Coupon Used'];
          const rows = [];

          table.querySelectorAll('tbody tr').forEach(row => {
            const rowData = Array.from(row.querySelectorAll('td')).map(cell => cell.textContent.trim());
            rows.push(rowData);
          });

          XLSX.utils.sheet_add_aoa(ws, [headers], { origin: -1 });
          XLSX.utils.sheet_add_aoa(ws, rows, { origin: -1 });

          const colWidths = headers.map((h, i) => {
            let maxLength = h.length;
            rows.forEach(row => {
              if (row[i] && row[i].length > maxLength) {
                maxLength = row[i].length;
              }
            });
            return { wch: maxLength + 5 };
          });

          ws['!cols'] = colWidths;
        }

        XLSX.utils.book_append_sheet(wb, ws, 'Sales Report');
        XLSX.writeFile(wb, 'sales-report.xlsx');
      }

    </script>
  </body>

  </html>
<%- include("../../views/partials/adminPartial/header") %>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
    /* DESKTOP — show full table */
    @media (min-width: 1024px) {
        .desktop-table {
            display: block;
            width: 100%;
        }
        .mobile-card {
            display: none;
        }
    }

    /* MOBILE/TABLET — hide table, show card view */
    @media (max-width: 1023px) {
        .desktop-table {
            display: none !important;
        }
        .mobile-card {
            display: block;
        }

        /* Fix main layout squeezing */
        .main-wrap {
            padding-left: 0 !important;
        }
    }

    /* FIX: Sidebar for large screens */
    .main-wrap {
        display: flex;
        min-height: 100vh;
        background-color: #1e1e2f;
        padding-left: 220px;
    }

    /* INCREASE TABLE HEIGHT FOR LAPTOP */
    .desktop-table {
        max-height: 650px;
        overflow-y: auto;
    }
</style>


<div class="main-wrap">
<section class="content-main w-full p-6 text-white">

    <!-- HEADER -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold">Coupon Management</h2>

        <button onclick="window.history.back()" 
                class="bg-gray-700 px-4 py-2 rounded text-white hover:bg-gray-600">
            ⬅ Go Back
        </button>
    </div>

    <!-- CONTENT GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- FORM SECTION -->
        <div class="bg-white text-black rounded-xl shadow p-5">
            <form method="post" action="/admin/Coupons/createCoupon" onsubmit="createCoupon(event)">
                
                <div class="mb-4">
                    <label class="font-medium">Coupon Name</label>
                    <input type="text" name="couponName" class="w-full border p-2 rounded" />
                    <div id="error-coupon-name" class="text-red-500 text-sm"></div>
                </div>

                <div class="mb-4">
                    <label class="font-medium">Start Date</label>
                    <input type="date" name="startDate" id="startingDate" class="w-full border p-2 rounded" />
                    <div id="error-start-date" class="text-red-500 text-sm"></div>
                </div>

                <div class="mb-4">
                    <label class="font-medium">End Date</label>
                    <input type="date" name="endDate" id="expiringDate" class="w-full border p-2 rounded" />
                    <div id="error-end-date" class="text-red-500 text-sm"></div>
                </div>

                <div class="mb-4">
                    <label class="font-medium">Offer Price</label>
                    <input type="text" name="offerPrice" class="w-full border p-2 rounded" />
                    <div id="error-offer-price" class="text-red-500 text-sm"></div>
                </div>

                <div class="mb-4">
                    <label class="font-medium">Minimum Price</label>
                    <input type="text" name="minimumPrice" class="w-full border p-2 rounded minimumPrice" />
                    <div id="error-minimum-price" class="text-red-500 text-sm"></div>
                </div>

                <button type="submit" 
                    class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
                    Add Coupon
                </button>

            </form>
        </div>
<!-- TABLE + MOBILE CARDS -->
<div class="lg:col-span-2 w-full">

    <!-- DESKTOP TABLE -->
    <div class="desktop-table bg-white rounded-xl shadow overflow-auto">
        <table class="table w-full">

            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Created On</th>
                    <th>Expire On</th>
                    <th>Offer</th>
                    <th>Min</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody>
                <% coupons.forEach(c => { %>
                <tr class="text-black">
                    <td><%= c.name %></td>
                    <td><%= new Date(c.createdOn).toLocaleDateString("en-US") %></td>
                    <td><%= new Date(c.expiredOn).toLocaleDateString("en-US") %></td>
                    <td>₹<%= c.offerPrice %></td>
                    <td>₹<%= c.minimumPrice %></td>

                    <td>
                        <% if (!c.islist) { %>
                        <button class="bg-green-600 text-white px-3 py-1 rounded"
                            onclick="Listed('<%= c._id %>','<%= c.name %>')">
                            List
                        </button>
                        <% } else { %>
                        <button class="bg-red-600 text-white px-3 py-1 rounded"
                            onclick="Unlisted('<%= c._id %>','<%= c.name %>')">
                            Unlist
                        </button>
                        <% } %>
                    </td>

                    <td>
                        <a class="bg-yellow-500 text-white px-3 py-1 rounded"
                            href="/admin/Coupons/editCoupon/<%= c._id %>">Edit</a>
                    </td>
                </tr>
                <% }) %>
            </tbody>
        </table>
    </div>

    <!-- MOBILE CARDS -->
    <div class="mobile-card grid gap-4 mt-4">
        <% coupons.forEach(c => { %>

        <div class="bg-[#2a2d3a] rounded-xl p-4 shadow text-white">

            <p class="text-lg font-semibold mb-2"><%= c.name %></p>

            <div class="text-gray-300 text-sm space-y-1">
                <p><strong>Created:</strong> <%= new Date(c.createdOn).toLocaleDateString('en-US') %></p>
                <p><strong>Expires:</strong> <%= new Date(c.expiredOn).toLocaleDateString('en-US') %></p>
                <p><strong>Offer:</strong> ₹<%= c.offerPrice %></p>
                <p><strong>Min Price:</strong> ₹<%= c.minimumPrice %></p>
            </div>

            <div class="mt-4 flex flex-col gap-2">

                <% if (!c.islist) { %>
                <button class="bg-green-600 py-2 rounded text-white"
                    onclick="Listed('<%= c._id %>', '<%= c.name %>')">
                    List
                </button>
                <% } else { %>
                <button class="bg-red-600 py-2 rounded text-white"
                    onclick="Unlisted('<%= c._id %>', '<%= c.name %>')">
                    Unlist
                </button>
                <% } %>

                <a href="/admin/Coupons/editCoupon/<%= c._id %>"
                    class="bg-yellow-500 py-2 rounded text-center text-white">
                    Edit
                </a>
            </div>

        </div>
        <% }) %>
    </div>

</div>

    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <div style="color: #fff;">Showing <%= currentPage %>  of <%= totalPages %>
      </div>
      <nav>
        <ul class="pagination mb-0">
          <li class="page-item <%= currentPage == 1 ? 'disabled' : '' %>">
            <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= search %>">‹</a>
          </li>
    
          <% for (let i=1; i <=totalPages; i++) { %>
            <li class="page-item <%= currentPage == i ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>&search=<%= search %>">
                <%= i %>
              </a>
            </li>
            <% } %>
    
              <li class="page-item <%= currentPage == totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= search %>">›</a>
              </li>
        </ul>
      </nav>
    
    </div>
    </div>
    </div>
</section>
</div>

  <!-- JavaScript -->
   <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function Validateform() {
      document.querySelectorAll(".error-message").forEach((element) => (element.innerHTML = ""));
      const sDate = document.getElementById("startingDate").value;
      const eDate = document.getElementById("expiringDate").value;
      const sDateObj = new Date(sDate);
      const eDateObj = new Date(eDate);
      const todayDateObj = new Date();
      todayDateObj.setHours(0, 0, 0, 0);

      if (sDateObj > eDateObj) {
        document.getElementById("error-end-date").innerHTML = "End Date Should Be After The Start Date";
        return false;
      }

      if (sDateObj < todayDateObj) {
        document.getElementById("error-start-date").innerHTML = "Start Date Should Be Today or Later";
        return false;
      }

      const name = document.getElementsByName("couponName")[0].value;
      const nameRegex = /^[A-Za-z0-9 ]{1,50}$/;
      if (!nameRegex.test(name)) {
        document.getElementById("error-coupon-name").innerHTML = "Coupon name must be alphanumeric (max 50 characters)";
        return false;
      }

      const offerPriceInput = document.getElementsByName("offerPrice")[0];
      const minimumPriceInput = document.getElementsByClassName("minimumPrice")[0];
      const offerPrice = parseInt(offerPriceInput.value.trim());
      const minimumPrice = parseInt(minimumPriceInput.value.trim());

      if (isNaN(offerPrice) || isNaN(minimumPrice)) {
        document.getElementById("error-offer-price").innerHTML = "Enter valid numbers for prices";
        return false;
      }

      if (offerPrice >= minimumPrice) {
        document.getElementById("error-offer-price").innerHTML = "Offer price must be less than minimum price";
        return false;
      }

      return true;
    }

    async function createCoupon(event) {
    event.preventDefault(); 

    if (!Validateform()) {
      return; 
    }

    const form = event.target;
    const formData = new FormData(form);

    try {
      const response = await axios.post('/admin/Coupons/createCoupon', Object.fromEntries(formData) , {validateStatus:(status)=>status!=500});

      if (response.data.success) {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: response.data.message,
          confirmButtonColor: '#6c63ff'
        }).then(() => {
          window.location.reload();
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Coupon Error',
          text: response.data.message,
          confirmButtonColor: '#6c63ff'
        });
      }

    } catch (error) {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Something went wrong',
        text: 'Please try again later.',
        confirmButtonColor: '#6c63ff'
      });
    }
  }

    function setDefaultStartDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      document.getElementById("startingDate").value = `${year}-${month}-${day}`;
    }

    function Unlisted(id, name) {
      Swal.fire({
        title: 'Unlisted',
        text: "do you want Unlist this Coupon?",
        icon: "warning",
        showConfirmButton: true,
        showCancelButton: true
      }).then((result) => {
        if (result.isConfirmed) {
          axios.patch("/admin/Coupons/Unlist-Coupon", { id } , {validateStatus:(status)=>status!=500})
            .then(function (responce) {
              if (responce.data.success) {
                Swal.fire({
                  title: `${name} unlisted`,
                  icon: 'success',
                  showConfirmButton: false,
                  timer: 1500
                }).then(() => {
                  window.location.reload()
                })
              }
            })
        }
      })
    }

    function Listed(id, name) {
      Swal.fire({
        tittle: "List the Coupon",
        text: "do you want list the Coupon",
        icon: "warning",
        showConfirmButton: true,
        showCancelButton: true
      }).then((result) => {
        if (result.isConfirmed) {
          axios.patch("/admin/Coupons/list-Coupon", { id } , {validateStatus:(status)=>status!=500})
            .then(function (responce) {
              if (responce.data.success) {
                Swal.fire({
                  title: `${name} listed`,
                  icon: 'success',
                  showConfirmButton: false,
                  timer: 1500
                }).then(() => {
                  window.location.reload()
                })
              }
            })
        }
      })
    }

  </script>
<%- include("../../views/partials/adminPartial/header") %>
<script src="https://cdn.tailwindcss.com"></script>

<style>
/* --- FIX: Prevent content from sliding under sidebar --- */
.main-content {
  margin-left: 240px; /* Same as sidebar width */
  transition: all 0.3s ease;
}

/* Mobile / Tablet */
@media (max-width: 991px) {
  .main-content {
    margin-left: 0;
  }
}
</style>

<body class="bg-[#0f172a] text-white font-sans">

<div class="main-content px-4 py-8">

  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl md:text-3xl font-semibold">Products</h1>

    <div class="flex items-center gap-3">
      <button onclick="window.history.back()"
        class="hidden sm:inline-block bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded">
        ⬅ Go Back
      </button>

      <a href="/admin/Products/add-product"
        class="bg-cyan-400 hover:bg-cyan-300 text-black font-semibold px-4 py-2 rounded">
        ADD PRODUCT +
      </a>
    </div>
  </div>

  <!-- Search Box -->
  <div class="mb-4">
    <input id="productSearch"
      class="w-full md:w-1/2 bg-[#1e293b] text-white p-3 rounded outline-none focus:ring-2 focus:ring-cyan-400"
      placeholder="Search for Products">
  </div>

  <!-- DESKTOP TABLE -->
  <div class="hidden md:block bg-transparent">
    <div class="overflow-x-auto rounded-lg border border-gray-700">
      <table class="min-w-full table-auto border-collapse">
        <thead>
          <tr class="bg-black">
            <th class="px-4 py-3 text-sm text-white">IMAGE</th>
            <th class="px-4 py-3 text-sm text-white">NAME</th>
            <th class="px-4 py-3 text-sm text-white">DESCRIPTION</th>
            <th class="px-4 py-3 text-sm text-white">CATEGORY</th>
            <th class="px-4 py-3 text-sm text-white">REGULAR(₹)</th>
            <th class="px-4 py-3 text-sm text-white">SALE(₹)</th>
            <th class="px-4 py-3 text-sm text-white">OFFER</th>
            <th class="px-4 py-3 text-sm text-white">STOCK</th>
            <th class="px-4 py-3 text-sm text-white">ACTION</th>
          </tr>
        </thead>

        <tbody>

          <% products.forEach(function(product,index) { %>
          <tr class="border-b border-gray-800">
            <td class="px-4 py-3">
              <img src="<%= product.productImage[0] %>" width="60" height="60"
                class="object-cover rounded">
            </td>

            <td class="px-4 py-3 text-sm"><%= product.productName %></td>

            <td class="px-4 py-3 text-sm max-w-[250px] truncate"><%= product.description %></td>

            <td class="px-4 py-3 text-sm"><%= product.category.name %></td>

            <td class="px-4 py-3 text-sm">₹ <%= product.regularPrice %></td>

            <td class="px-4 py-3 text-sm">
              <select class="bg-[#0b1220] text-white px-2 py-1 rounded">
                <% product.variant.forEach(v => { %>
                <option><%= v.size %>: ₹<%= v.salePrice.toFixed(2) %></option>
                <% }) %>
              </select>
            </td>

            <td class="px-4 py-3 text-sm">
              <span><%= product.productOffer ? product.productOffer + '%' : '0%' %></span>

              <div class="mt-2">
                <% if(product.productOffer > 0) { %>
                <button onclick="editOffer('<%= product._id %>')"
                  class=" text-decorating-none text-xs px-2 py-1 rounded bg-yellow-400 text-black mr-1">Edit</button>

                <button onclick="removeOffer('<%= product._id %>')"
                  class="text-xs px-2 py-1 rounded bg-red-600 text-white">Remove</button>

                <% } else { %>
                <button onclick="addOffer('<%= product._id %>')"
                  class="text-xs px-2 py-1 rounded bg-green-600 text-white">Add Offer</button>
                <% } %>
              </div>
            </td>

            <td class="px-4 py-3 text-sm"><%= product.quatity %></td>

            <td class="px-4 py-3">
              <div class="flex gap-2">
                <a href="/admin/Products/edit-product/<%= product._id %>"
                  class="px-3 py-1 text-sm rounded bg-white/10 hover:bg-white/20">✎</a>

                <% if(!product.isBlocked) { %>
                <button onclick="confirmBlockProduct(event,'<%= product._id %>')"
                  class="px-3 py-1 rounded bg-red-600 text-white">Block</button>
                <% } else { %>
                <button onclick="confirmUnblockProduct(event,'<%= product._id %>')"
                  class="px-3 py-1 rounded bg-green-600 text-white">Unblock</button>
                <% } %>
              </div>
            </td>
          </tr>
          <% }) %>

        </tbody>

      </table>
    </div>
  </div>

  <!-- MOBILE VIEW -->
  <div class="md:hidden space-y-4 mt-6">
    <% products.forEach(function(product,index) { %>
    <div class="bg-[#1e293b] p-4 rounded-lg shadow">
      <div class="flex gap-3">
        <img src="<%= product.productImage[0] %>" class="w-20 h-20 rounded object-cover">

        <div class="flex-1">
          <h3 class="text-lg font-semibold"><%= product.productName %></h3>
          <p class="text-sm text-gray-300 line-clamp-3"><%= product.description %></p>

          <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
            <div>
              <span class="text-xs text-gray-400">Category</span>
              <div><%= product.category.name %></div>
            </div>

            <div>
              <span class="text-xs text-gray-400">Regular Price</span>
              <div>₹ <%= product.regularPrice %></div>
            </div>

            <div>
              <span class="text-xs text-gray-400">Sale</span>
              <div>
                <% if(product.variant.length) { %>
                <%= product.variant[0].size %> :
                ₹<%= product.variant[0].salePrice.toFixed(2) %>
                <% } else { %>-<% } %>
              </div>
            </div>

            <div>
              <span class="text-xs text-gray-400">Stock</span>
              <div><%= product.quatity %></div>
            </div>
          </div>

          <div class="mt-3 flex flex-wrap gap-2">
            <% if(product.productOffer > 0) { %>
            <button onclick="editOffer('<%= product._id %>')" class="text-xs px-2 py-1 rounded bg-yellow-400 text-black">Edit Offer</button>
            <button onclick="removeOffer('<%= product._id %>')" class="text-xs px-2 py-1 rounded bg-red-600 text-white">Remove</button>
            <% } else { %>
            <button onclick="addOffer('<%= product._id %>')" class="text-xs px-2 py-1 rounded bg-green-600 text-white">Add Offer</button>
            <% } %>

            <a href="/admin/Products/edit-product/<%= product._id %>" class="text-xs px-2 py-1 rounded bg-white/10">Edit</a>

            <% if(!product.isBlocked) { %>
            <button onclick="confirmBlockProduct(event,'<%= product._id %>')" class="text-xs px-2 py-1 rounded bg-red-600 text-white">Block</button>
            <% } else { %>
            <button onclick="confirmUnblockProduct(event,'<%= product._id %>')" class="text-xs px-2 py-1 rounded bg-green-600 text-white">Unblock</button>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <% }) %>
  </div>

</div>

<div class="d-flex justify-content-between align-items-center mt-3">
    <div style="color: #fff;">Showing <%= currentPage %>  of <%= totalPages %>
    </div>
    <nav>
        <ul class="pagination mb-0">
            <li class="page-item <%= currentPage == 1 ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= search %>">‹</a>
            </li>

            <% for (let i=1; i <=totalPages; i++) { %>
                <li class="page-item <%= currentPage == i ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>&search=<%= search %>">
                        <%= i %>
                    </a>
                </li>
                <% } %>

                    <li class="page-item <%= currentPage == totalPages ? 'disabled' : '' %>">
                        <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= search %>">›</a>
                    </li>
        </ul>
    </nav>

</div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>

            document.getElementById('productSearch').addEventListener('keyup', function () {


                let searchValue = this.value.toLowerCase();
                let rows = document.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    let productName = row.children[2].textContent.toLowerCase();
                    if (productName.includes(searchValue)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });




            function confirmBlockProduct(event, productId) {
                event.preventDefault();
                Swal.fire({
                    title: "Are you sure?",
                    text: "You are about to block this product!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Yes, Block!",
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/admin/Products/blockProduct?id=${productId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: productId })
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                if (data.success) {
                                    Swal.fire({
                                        title: 'Success!',
                                        text: data.message,
                                        icon: 'success'
                                    }).then(() => {
                                        location.reload()
                                    })
                                } else {
                                    Swal.fire({
                                        title: 'Failed!',
                                        text: data.message,
                                        icon: 'error'
                                    }).then(() => {
                                        location.reload()
                                    })
                                }
                            })
                            .catch((error) => {
                                console.error("error occur on blocking ajax", error)
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'Something went wrong in server Side',
                                    icon: 'error'
                                })
                            })
                    }
                });
            }

            function confirmUnblockProduct(event, productId) {
                event.preventDefault();
                Swal.fire({
                    title: "Are you sure?",
                    text: "You are about to unblock this product!",
                    icon: "info",
                    showCancelButton: true,
                    confirmButtonColor: "#28a745",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Yes, Unblock!",
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/admin/Products/unblockProduct?id=${productId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: productId })
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                if (data.success) {
                                    Swal.fire({
                                        title: 'Success!',
                                        text: data.message,
                                        icon: 'success'
                                    }).then(() => {
                                        location.reload()
                                    })
                                } else {
                                    Swal.fire({
                                        title: 'Failed!',
                                        text: data.message,
                                        icon: 'error'
                                    }).then(() => {
                                        location.reload()
                                    })
                                }
                            }).catch((error) => {
                                console.error("error occur on unblocking ajax", error)
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'something went wrong on serverSide',
                                    icon: 'error'
                                })
                            })
                    }
                });
            }

            function removeOffer(categoryId) {
  Swal.fire({
    title: 'Remove Offer',
    text: "Are you sure you want to remove this offer?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, remove it"
  }).then((result) => {
    if (result.isConfirmed) {
      axios.post("/admin/Products/remove-product-offer", { id: categoryId })
        .then(response => {
          if (response.data.success) {
            Swal.fire({
              title: 'Offer Removed',
              icon: 'success',
              showConfirmButton: false,
              timer: 1500
            }).then(() => {
              window.location.reload();
            });
          }
        });
    }
  });
}

async function addOffer(productId) {
  const { value: offer } = await Swal.fire({
    title: 'Add Offer',
    input: 'number',
    inputLabel: 'Enter Offer Percentage',
    inputPlaceholder: '%',
    inputAttributes: {
      min: 1,
      max: 99,
      step: 1
    },
    showCancelButton: true,
    confirmButtonText: 'Add Offer',
    preConfirm: (value) => {
      if (!value || value <= 0 || value >= 100) {
        Swal.showValidationMessage('Please enter a valid percentage (1–99)');
      }
      return value;
    }
  });

  if (offer) {
    try {
      const response = await axios.post('/admin/Products/add-product-offer', {
        id: productId,
        offer: offer
      });

      if (response.data.success) {
        Swal.fire({
          title: 'Offer Added!',
          text: `Final Offer: ${response.data.finalOffer}%. Sale Price: ₹${response.data.salePrice}`,
          icon: 'success',
          showConfirmButton: false,
          timer: 1500
        }).then(() => {
          window.location.reload();
        });
      } else {
        Swal.fire('Error', 'Failed to add offer.', 'error');
      }
    } catch (error) {
      console.error('Error adding offer:', error);
      Swal.fire('Error', 'Something went wrong while adding the offer.', 'error');
    }
  }
}

  async function editOffer(categoryId) {
  try {
    const response = await axios.get(`/admin/Products/get-product-offer/${categoryId}`);
    const currentOffer = response.data.offer || 0;

    const { value: newOffer } = await Swal.fire({
      title: 'Edit Offer',
      input: 'number',
      inputLabel: 'Update Offer Percentage',
      inputValue: currentOffer,
      inputPlaceholder: '%',
      inputAttributes: {
        min: 1,
        max: 99,
        step: 1
      },
      showCancelButton: true,
      confirmButtonText: 'Update Offer',
      preConfirm: (value) => {
        if (!value || value <= 0 || value >= 100) {
          Swal.showValidationMessage('Please enter a valid percentage (1–99)');
        }
        return value;
      }
    });

    if (newOffer !== undefined) {
      const updateRes = await axios.patch('/admin/Products/edit-product-offer', {
        id: categoryId,
        offer: newOffer
      });

      if (updateRes.data.success) {
        Swal.fire({
          title: 'Offer Updated!',
          text: `New offer of ${newOffer}% saved successfully.`,
          icon: 'success',
          showConfirmButton: false,
          timer: 1500
        }).then(() => {
          window.location.reload();
        });
      } else {
        Swal.fire('Error', 'Failed to update offer.', 'error');
      }
    }
  } catch (error) {
    console.error(error);
    Swal.fire('Error', 'Something went wrong while editing the offer.', 'error');
  }
}


        </script>

    </body>

  
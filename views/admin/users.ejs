<%- include("../../views/partials/adminPartial/header") %>

<!-- Tailwind for responsiveness -->
<script src="https://cdn.tailwindcss.com"></script>

<div class="main-content px-4 md:px-10 py-6">

  <!-- Page Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold text-white">Users</h2>
    <button onclick="window.history.back()" 
      class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">
      ⬅ Go Back
    </button>
  </div>

  <!-- Search -->
  <div class="mb-4">
    <input 
      type="text" 
      id="productSearch" 
      placeholder="Search for Users"
      class="w-full bg-[#1e293b] text-white placeholder-gray-400 px-4 py-3 rounded outline-none"
    />
  </div>

  <!-- DESKTOP TABLE (md and above) -->
  <div class="hidden md:block bg-[#1e293b] rounded-lg overflow-hidden shadow">
    <table class="w-full text-white">
      <thead class="bg-black text-white">
        <tr>
          <th class="p-3 text-left">User Image</th>
          <th class="p-3 text-left">User Name</th>
          <th class="p-3 text-left">Email</th>
          <th class="p-3 text-left">Action</th>
        </tr>
      </thead>

      <tbody>
        <% users.forEach(user => { %>
        <tr class="border-b border-gray-700">
          <td class="p-3">
            <img 
              src="<%= user.image && user.image.length > 0 ? user.image[0] : '/wallpaper/banner.png' %>"  
              class="h-12 w-12 rounded object-cover"
            />
          </td>

          <td class="p-3 text-white"><%= user.name %></td>
          <td class="p-3 text-white"><%= user.email %></td>

          <td class="p-3" id="action-<%= user._id %>">
            <% if(user.isBlocked) { %>
              <button 
                class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded"
                onclick="UnblockUser('<%= user._id %>', '<%= user.name %>')"
              >Unblock</button>
            <% } else { %>
              <button 
                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded"
                onclick="BlockUser('<%= user._id %>', '<%= user.name %>')"
              >Block</button>
            <% } %>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- MOBILE VIEW (cards) -->
  <div class="md:hidden space-y-4">
    <% users.forEach(user => { %>
      <div class="bg-[#1e293b] text-white p-4 rounded-lg shadow border border-gray-700">
        
        <div class="flex items-center gap-4">
          <img 
            src="<%= user.image && user.image.length > 0 ? user.image[0] : '/wallpaper/banner.png' %>"  
            class="h-14 w-14 rounded object-cover"
          />

          <div>
            <p class="font-semibold text-lg"><%= user.name %></p>
            <p class="text-gray-300 text-sm"><%= user.email %></p>
          </div>
        </div>

        <!-- Buttons -->
        <div class="mt-4" id="action-<%= user._id %>">
          <% if (user.isBlocked) { %>
            <button 
              class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded"
              onclick="UnblockUser('<%= user._id %>', '<%= user.name %>')"
            >
              Unblock
            </button>
          <% } else { %>
            <button 
              class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded"
              onclick="BlockUser('<%= user._id %>', '<%= user.name %>')"
            >
              Block
            </button>
          <% } %>
        </div>

      </div>
    <% }) %>
  </div>

  
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div style="color: #fff;">Showing <%= currentPage %>  of <%= totalPages %>
        </div>
        <nav>
          <ul class="pagination mb-0">
            <li class="page-item <%= currentPage == 1 ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= search %>">‹</a>
            </li>

            <% for (let i=1; i <=totalPages; i++) { %>
              <li class="page-item <%= currentPage == i ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>&search=<%= search %>">
                  <%= i %>
                </a>
              </li>
              <% } %>

                <li class="page-item <%= currentPage == totalPages ? 'disabled' : '' %>">
                  <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= search %>">›</a>
                </li>
          </ul>
        </nav>

      </div>

</div>

<!-- SweetAlert + Axios -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  // Search function
  document.getElementById("productSearch").addEventListener("keyup", function () {
    const searchValue = this.value.toLowerCase();
    const rows = document.querySelectorAll("tbody tr");
    const cards = document.querySelectorAll(".md\\:hidden > div");

    // Desktop table search
    rows.forEach(row => {
      let name = row.children[1].textContent.toLowerCase();
      row.style.display = name.includes(searchValue) ? "" : "none";
    });

    // Mobile card search
    cards.forEach(card => {
      let name = card.querySelector(".font-semibold").textContent.toLowerCase();
      card.style.display = name.includes(searchValue) ? "" : "none";
    });
  });

  // Block / Unblock Functions
  function BlockUser(id, name) {
    Swal.fire({
      title: "Block User?",
      text: "Do you want to block this user?",
      icon: "warning",
      showCancelButton: true
    }).then((result) => {
      if (result.isConfirmed) {
        axios.patch("/admin/users/blockUser", { id }).then(res => {
          if (res.data.success) {
            location.reload();
          }
        });
      }
    });
  }

  function UnblockUser(id, name) {
    Swal.fire({
      title: "Unblock User?",
      text: "Do you want to unblock this user?",
      icon: "question",
      showCancelButton: true
    }).then((result) => {
      if (result.isConfirmed) {
        axios.patch("/admin/users/UnblockUser", { id }).then(res => {
          if (res.data.success) {
            location.reload();
          }
        });
      }
    });
  }
</script>

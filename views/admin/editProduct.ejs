<!-- ADMIN HEADER -->
<%- include("../../views/partials/adminPartial/header") %>

    <!-- TAILWIND CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Cropper CSS (kept) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">

    <body class="bg-[#0f172a] text-white min-h-screen flex justify-center px-4 py-10">

        <div class="w-full max-w-4xl bg-[#1e293b] p-8 md:p-12 rounded-2xl shadow-2xl">

            <!-- Back Button -->
            <button onclick="window.history.back()"
                class="mb-6 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded flex items-center gap-2">
                â¬… Go Back
            </button>

            <h1 class="text-2xl md:text-3xl font-semibold mb-6">Edit Product</h1>

            <div class="space-y-6">

                <!-- Form container (keeping your original form name to preserve JS) -->
                <form name="productForm" action="/admin/Products/edit-product/<%=product._id%>" method="POST"
                    enctype="multipart/form-data" class="space-y-6">

                    <!-- Grid (two columns on md+) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <!-- Product Name -->
                        <div>
                            <label class="block text-sm font-medium mb-1">Product Name:</label>
                            <p id="name-error" class="text-red-400 text-sm mb-1"></p>
                            <input type="text"
                                class="form-control w-full p-3 rounded bg-white text-black outline-none focus:ring-2 focus:ring-cyan-400"
                                id="name" name="name" value="<%=product.productName%>" pattern="^[A-Za-z ]+$"
                                title="Only alphabets and spaces allowed." maxlength="100" />
                        </div>

                        <!-- Category -->
                        <div>
                            <label class="block text-sm font-medium mb-1">Product Category:</label>
                            <p id="category-error" class="text-red-400 text-sm mb-1"></p>
                            <select
                                class="form-select w-full p-3 rounded bg-white text-black outline-none focus:ring-2 focus:ring-cyan-400"
                                id="category" name="category">
                                <option disabled>Select categories</option>
                                <% categories.forEach(category=> { %>
                                    <option value="<%= category._id %>" <%=category.name===product.category.name
                                        ? 'selected' : '' %>>
                                        <%= category.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>

                        <!-- Description (span both columns) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-1">Product Description:</label>
                            <p id="description-error" class="text-red-400 text-sm mb-1"></p>
                            <textarea
                                class="form-control w-full p-3 rounded bg-white text-black outline-none focus:ring-2 focus:ring-cyan-400"
                                id="description" name="description" rows="3" pattern="^[A-Za-z]+$"
                                title="Only alphabets allowed, no spaces or numbers."
                                maxlength="100"><%= product.description %></textarea>
                        </div>

                        <!-- Offer -->
                        <div>
                            <label class="block text-sm font-medium mb-1">Offer (%):</label>
                            <p id="offer-error" class="text-red-400 text-sm mb-1"></p>
                            <input type="number"
                                class="form-control w-full p-3 rounded bg-white text-black outline-none focus:ring-2 focus:ring-cyan-400"
                                id="offer" value="<%=product.productOffer%>" name="offer" min="0" max="99"
                                placeholder="Optional" />
                        </div>

                        <!-- Price -->
                        <div>
                            <label class="block text-sm font-medium mb-1">Price</label>
                            <p id="price-error" class="text-red-400 text-sm mb-1"></p>
                            <input type="number"
                                class="form-control w-full p-3 rounded bg-white text-black outline-none focus:ring-2 focus:ring-cyan-400"
                                id="price" value="<%=product.regularPrice%>" name="price" min="0"
                                placeholder="Greater than SalesPrice" />
                        </div>

                    </div> <!-- end grid -->

                    <!-- VARIANT SECTION (converted visually but keep DOM names) -->
                    <div id="variant-section">
                        <label class="block text-sm font-medium mb-3">Product Variants</label>

                        <div id="variant-container" class="space-y-3">
                            <% if (product.variant && product.variant.length> 0) { %>
                                <% product.variant.forEach((v, i)=> { %>
                                    <div class="variant-row grid grid-cols-3 gap-3 items-center mb-3"
                                        data-index="<%= i %>">
                                        <input type="text" name="variantSize[]"
                                            class="form-control p-3 rounded bg-white text-black outline-none"
                                            value="<%= v.size %>" placeholder="Size" />
                                        <input type="number" name="variantPrice[]"
                                            class="form-control p-3 rounded bg-white text-black outline-none"
                                            value="<%= v.salePrice %>" placeholder="Sales Price" />
                                        <div class="flex items-center gap-2">
                                            <input type="number" name="variantQuantity[]"
                                                class="form-control p-3 rounded bg-white text-black outline-none"
                                                value="<%= v.quantity %>" placeholder="Stock" />
                                            </div>
                                            <button type="button"
                                                class="btn btn-danger bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded"
                                                onclick="removeVariant(this)">Remove</button>
                                    </div>
                                    <% }) %>
                                        <% } else { %>
                                            <div class="variant-row grid grid-cols-3 gap-3 items-center mb-3"
                                                data-index="0">
                                                <input type="text" name="variantSize[]"
                                                    class="form-control p-3 rounded bg-white text-black outline-none"
                                                    placeholder="Size" />
                                                <input type="number" name="variantPrice[]"
                                                    class="form-control p-3 rounded bg-white text-black outline-none"
                                                    placeholder="Sales Price" />
                                                <div class="flex items-center gap-2">
                                                    <input type="number" name="variantQuantity[]"
                                                        class="form-control p-3 rounded bg-white text-black outline-none"
                                                        placeholder="Stock" />
                                                    </div>
                                                    <button type="button"
                                                        class="btn btn-danger bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded"
                                                        onclick="removeVariant(this)">Remove</button>
                                            </div>
                                            <% } %>
                        </div>

                        <button type="button" class="mt-3 bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded"
                            onclick="addVariant()">+ Add Variant</button>
                    </div>

                    <!-- IMAGES SECTION -->
                    <div>
                        <label class="block text-sm font-medium mb-3">Product Images</label>

                        <!-- Keep rows for JS compatibility -->
                        <div class="row grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <% for (let i=0; i < 4; i++) { %>

                                <div class="col-md-3 mb-3 w-full">
                                    <div
                                        class="card w-full border border-gray-600 rounded-xl p-4 bg-[#111827] flex flex-col space-y-3">

                                        <!-- Label -->
                                        <label class="block text-center font-medium tracking-wide text-white mb-2">
                                            Image <%= i + 1 %>
                                        </label>

                                        <!-- IF IMAGE EXISTS -->
                                        <% if (product.productImage[i]) { %>

                                            <!-- EXISTING IMAGE -->
                                            <img src="<%= product.productImage[i] %>"
                                                class="w-32 h-32 object-cover rounded shadow mx-auto" />

                                            <!-- DELETE BUTTON -->
                                            <button type="button"
                                                onclick="deleteSingleImage('<%= product.productImage[i] %>', '<%= product._id %>', <%= i %>)"
                                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded mx-auto">
                                                Delete Image
                                            </button>

                                            <!-- Hidden existing input -->
                                            <input type="hidden" name="existingImage<%= i+1 %>"
                                                value="<%= product.productImage[i] %>" />

                                            <% } else { %>

                                                <!-- IF NO IMAGE EXISTS -->

                                                <!-- CHOOSE FILE -->
                                                <p id="image<%= i+1 %>-error" class="text-red-400 text-sm"></p>
                                                <input type="file" name="image<%= i+1 %>" accept=".jpg,.jpeg,.png"
                                                    class="w-full text-white file:bg-cyan-500 file:px-4 file:py-2 file:rounded"
                                                    onchange="previewImage(event, <%= i %>)" />

                                                <!-- PREVIEW BEFORE CROP -->
                                                <div id="preview-container-<%= i %>"
                                                    class="hidden mt-3 flex justify-center">
                                                    <img id="preview<%= i %>"
                                                        class="w-32 h-32 object-cover rounded shadow" />
                                                </div>

                                                <!-- CROPPED PREVIEW -->
                                                <div class="croppedPreview<%= i %> mt-3 flex justify-center"></div>

                                                <!-- SAVE CROPPED IMAGE BUTTON -->
                                                <button id="crop-btn-<%= i %>" type="button"
                                                    onclick="cropImage(<%= i %>)"
                                                    class="hidden bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded mx-auto">
                                                    Save Image <%= i + 1 %>
                                                </button>

                                                <% } %>

                                    </div>
                                </div>

                                <% } %>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div>
                        <button type="submit"
                            class="w-full bg-cyan-400 hover:bg-cyan-300 text-black font-semibold py-3 rounded-lg text-lg">EDIT
                            PRODUCT</button>
                    </div>

                </form>

            </div> <!-- end wrapper -->

        </div> <!-- container -->

        <!-- SCRIPTS: Cropper, SweetAlert included (you had these earlier) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>
            /* ---------- Keep your functions exactly as they were; only ensure cropper preview + crop works ---------- */

            let croppers = [];

            function previewImage(event, index) {
                const input = event.target;
                const file = input.files[0];
                document.getElementById(`preview-container-${index}`).classList.remove("hidden");
                document.getElementById(`crop-btn-${index}`).classList.remove("hidden");


                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];

                if (file) {
                    console.log(`File selected for image${index + 1}:`, file.name);

                    if (!allowedTypes.includes(file.type)) {
                        Swal.fire({
                            title: 'Error!',
                            text: 'Only JPG, JPEG, and PNG images are allowed.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });

                        input.value = '';
                        const previewContainer = input.parentElement.querySelector('.preview-container');

                        if (previewContainer) previewContainer.style.display = 'none';
                        if (croppers[index]) {
                            croppers[index].destroy();
                            croppers[index] = null;
                        }
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const previewContainer = input.parentElement.querySelector('.preview-container');
                        const preview = document.getElementById(`preview${index}`);
                        preview.src = e.target.result;
                        if (previewContainer) previewContainer.style.display = 'block';

                        if (croppers[index]) {
                            croppers[index].destroy();
                        }

                        croppers[index] = new Cropper(preview, {
                            aspectRatio: 1,
                            viewMode: 1,
                            autoCropArea: 1,
                            ready: function () {
                                console.log(`Cropper initialized for image${index + 1}`);
                                // ensure the crop box is visible
                                try { this.cropper.crop(); } catch (err) { /* ignore */ }
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                } else {
                    console.log(`No file selected for image${index + 1}`);
                }
            }

            async function deleteSingleImage(imageName, productId, index) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const response = await fetch('/admin/Products/deleteImage', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    imageNameToServer: imageName,
                                    productIdToServer: productId,
                                    imageIndex: index
                                }),
                            });

                            const data = await response.json();

                            if (data.success) {
                                Swal.fire({
                                    title: 'Success!',
                                    text: 'Image deleted successfully.',
                                    icon: 'success',
                                    timer: 1500,
                                    showConfirmButton: false
                                });

                                // Keep the same selector your original code uses so behavior is unchanged
                                const card = document.querySelector(`.col-md-3:nth-child(${index + 1}) .card`);
                                if (card) {
                                    card.innerHTML = `
    <label class="block text-center font-medium tracking-wide text-white mb-2">
        Image ${index + 1}
    </label>

    <p id="image${index + 1}-error" class="text-red-400 text-sm"></p>

    <input 
        type="file" 
        name="image${index + 1}" 
        accept=".jpg,.jpeg,.png"
        class="w-full text-white file:bg-cyan-500 file:px-4 file:py-2 file:rounded"
        onchange="previewImage(event, ${index})"
    />

    <div id="preview-container-${index}" class="hidden mt-3 flex justify-center">
        <img 
            id="preview${index}" 
            class="w-32 h-32 object-cover rounded shadow"
        />
    </div>

    <div class="croppedPreview${index} mt-3 flex justify-center"></div>

    <button 
        id="crop-btn-${index}" 
        type="button"
        onclick="cropImage(${index})"
        class="hidden bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded mx-auto"
    >
        Save Image ${index + 1}
    </button>
`;
                                }
                            } else {
                                Swal.fire({
                                    title: 'Error!',
                                    text: data.message || 'Failed to delete the image.',
                                    icon: 'error',
                                });
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            Swal.fire({
                                title: 'Error!',
                                text: 'An error occurred while deleting the image.',
                                icon: 'error',
                            });
                        }
                    }
                });
            }

            function validateInput(input) {
                const errorElement = document.getElementById(`${input.id}-error`);
                if (!errorElement) {
                    return true;
                }
                if (!input.checkValidity()) {
                    errorElement.textContent = input.validationMessage;
                    return false;
                } else {
                    errorElement.textContent = '';
                    return true;
                }
            }

            const form = document.forms['productForm'];
            form.addEventListener('submit', async function (event) {
                event.preventDefault();
                let isValid = true;

                document.querySelectorAll('input:not([type="file"]), textarea, select').forEach((input) => {
                    if (!validateInput(input)) {
                        isValid = false;
                    }
                });

                if (!isValid) {
                    console.log('Validation failed, form not submitted');
                    return;
                }

                const formData = new FormData(this);

                console.log('FormData before images:');
                for (let pair of formData.entries()) {
                    console.log(`${pair[0]}:`, pair[1]);
                }

                //  cropped images
                for (let i = 0; i < 4; i++) {
                    if (croppers[i] && croppers[i].getCroppedCanvas()) {
                        try {
                            console.log(`Processing image ${i + 1}`);
                            const blob = await new Promise((resolve) => {
                                croppers[i].getCroppedCanvas({ width: 800, height: 800 }).toBlob(resolve, 'image/jpeg', 0.9);
                            });
                            console.log(`Blob for image${i + 1}:`, blob);
                            formData.set(`image${i + 1}`, blob, `image-${Date.now()}-${i}.jpg`);
                        } catch (error) {
                            console.error(`Error processing image ${i + 1}:`, error);
                            Swal.fire('Error', `Failed to process image ${i + 1}.`, 'error');
                            return;
                        }
                    } else {
                        console.log(`No cropper or canvas for image ${i + 1}`);
                    }
                }

                console.log('Final FormData:');
                for (let pair of formData.entries()) {
                    console.log(`${pair[0]}:`, pair[1]);
                }

                try {
                    console.log('Submitting to:', this.action);
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);

                    if (data.success) {
                        Swal.fire({
                            title: 'Success!',
                            text: 'Product updated successfully.',
                            icon: 'success'
                        }).then(() => window.location.href = '/admin/products');
                    } else {
                        Swal.fire('Warnning', data.message || 'Failed to update product.', 'Warnning');
                    }
                } catch (error) {
                    console.error('Submission error:', error);
                    Swal.fire('Error', `An error occurred during submission: ${error.message}`, 'error');
                }
            });

            function addVariant() {
                const container = document.getElementById("variant-container");
                const index = container.children.length;
                const newVariant = document.createElement("div");
                newVariant.className = "variant-row mb-3";
                newVariant.dataset.index = index;
                newVariant.innerHTML = `
        <input type="text" name="variantSize[]" class="form-control d-inline w-25 me-2 p-3 rounded bg-white text-black outline-none" placeholder="Size"  />
        <input type="number" name="variantPrice[]" class="form-control d-inline w-25 me-2 p-3 rounded bg-white text-black outline-none" placeholder="Sales Price"  />
        <input type="number" name="variantQuantity[]" class="form-control d-inline w-25 me-2 p-3 rounded bg-white text-black outline-none" placeholder="Stock"  />
        <button type="button" class="btn btn-danger bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded" onclick="removeVariant(this)">Remove</button>
      `;
                container.appendChild(newVariant);
            }

            function removeVariant(button) {
                const row = button.closest(".variant-row");
                if (row) row.remove();
            }

        </script>

    </body>
<%- include("../../views/partials/userPartial/header") %>


<style>
  body {
    font-family: 'Poppins', sans-serif;
    background-color: #FFF8F3;
  }

  main {
    flex: 1;
  }

  /* ---------------- SIDEBAR ---------------- */
  .sidebar {
    background-color: #F2E8DC;
    padding: 25px 20px;
    color: #6B4C3B;
    border-radius: 8px;
  }

  .sidebar h5 {
    font-weight: bold;
    margin-bottom: 15px;
    text-transform: uppercase;
  }

  .sidebar a {
    display: flex;
    align-items: center;
    color: #333;
    margin-bottom: 10px;
    text-decoration: none;
    font-weight: 500;
    padding: 10px 12px;
    border-radius: 6px;
    transition: 0.3s ease;
  }

  .sidebar a:hover {
    background-color: rgba(181, 101, 75, 0.15);
    color: #B5654B;
  }

  .sidebar a i {
    margin-right: 8px;
    font-size: 16px;
    color: #333;
  }

  /* -------------- PROFILE HEADER -------------- */
  .hero img {
    height: 350px;
    object-fit: cover;
  }

  .back-arrow-btn {
  position: absolute;
  top: 20px;          /* smaller consistent spacing */
  left: 20px;
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10;
}

.back-arrow-btn:hover {
  background-color: #B5654B;
  transform: scale(1.1);
}

/* ⭐ Mobile Fix: Move arrow up slightly */
@media (max-width: 768px) {
  .back-arrow-btn {
    top: 10px;
    left: 10px;
    width: 38px;
    height: 38px;
    font-size: 1.2rem;
  }
}

/* ⭐ Extra small screens */
@media (max-width: 480px) {
  .back-arrow-btn {
    top: 8px;
    left: 8px;
    width: 34px;
    height: 34px;
    font-size: 1rem;
  }
}


  /* ---------------- PROFILE CONTAINER ---------------- */
  .profile-container {
    background-color: #F2E8DC;
    padding: 35px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  /* ----------- PROFILE IMAGE CENTERED ----------- */
  .profile-pic-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-bottom: 25px;
  }

  .profile-picture {
    width: 130px;
    height: 130px;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid #ccc;
  }

  .btn-upload {
    background: linear-gradient(90deg, #B5654B, #D17C63);
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 15px;
    display: flex;
    align-items: center;
    transition: 0.3s;
  }

  .btn-upload i {
    margin-right: 6px;
  }

  .btn-upload:hover {
    opacity: 0.9;
  }

  /* ---------------- FORM INPUTS ---------------- */
  .form-label {
    font-weight: 500;
  }

  .Error-message {
    color: red;
    font-size: 0.75rem;
    display: none;
  }

  /* ---------------- BUTTON AREA ---------------- */
  .button-block {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 25px;
    flex-wrap: wrap;
  }

  .action-btn {
    background: linear-gradient(90deg, #B5654B, #D17C63);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 26px;
    font-size: 16px;
    cursor: pointer;
    transition: 0.3s;
    text-decoration: none;
  }

  .action-btn:hover {
    opacity: 0.9;
  }
  h5.page-title{
    margin-left: 477px;
  }

  /* ---------------- MOBILE RESPONSIVE ---------------- */
  @media (max-width: 768px) {
    .sidebar {
      margin-bottom: 20px;
    }

    h5.page-title {
      font-size: 22px !important;
      text-align: center !important;
      padding-left: 0 !important;
      margin-left: 0 !important
    }

    .profile-container {
      padding: 20px;
    }

    .profile-picture {
      width: 110px;
      height: 110px;
    }

    .button-block {
      flex-direction: column;
      gap: 15px;
    }

    .action-btn {
      width: 100%;
      text-align: center;
    }
  }
   /* Sidebar (Desktop) */
    .sidebar {
      background-color: #F2E8DC;
      padding: 25px 18px;
      border-radius: 8px;
    }

    .sidebar h5 {
      font-weight: bold;
      margin-bottom: 18px;
      color: #6B4C3B;
    }

    .sidebar a {
      display: block;
      margin-bottom: 12px;
      color: #333;
      font-weight: 500;
      padding: 10px;
      border-radius: 6px;
      transition: 0.3s;
      text-decoration: none;
    }

    .sidebar a:hover {
      background: rgba(181, 101, 75, 0.15);
      color: #B5654B;
    }

    /* Mobile top bar */
    .mobile-settings-bar {
      display: none;
      background: #F2E8DC;
      padding: 12px 18px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .mobile-settings-title {
      font-size: 18px;
      font-weight: bold;
      color: #6B4C3B;
    }

    .mobile-hamburger-btn {
      background: none;
      border: none;
      font-size: 28px;
      font-weight: bold;
      color: #6B4C3B;
      cursor: pointer;
    }

    /* Hide desktop sidebar on mobile */
    @media (max-width: 768px) {
      .sidebar {
        display: none !important;
      }

      .mobile-settings-bar {
        display: flex;
        justify-content: space-between;
      }
    }

    /* Drop-down (mobile) */
    .mobile-dropdown {
      display: none;
      flex-direction: column;
      background: #F2E8DC;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      animation: fadeIn 0.3s ease;
    }

    .mobile-dropdown a {
      padding: 10px 12px;
      font-size: 15px;
      text-decoration: none;
      color: #333;
      display: flex;
      align-items: center;
      border-radius: 6px;
      transition: 0.2s;
    }

    .mobile-dropdown a:hover {
      background: rgba(181, 101, 75, 0.15);
      color: #B5654B;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
</style>


<main>

  <!-- PROFILE HEADER -->
  <section class="hero text-center bg-light p-0 mb-4 position-relative">
    <img src="/wallpaper/pageBanner-1.jpg" class="img-fluid w-100" />
    <button onclick="window.history.back()" class="back-arrow-btn">&#8592;</button>
    <h1 class="position-absolute top-50 start-50 translate-middle text-white fw-bold display-4"
      style="text-shadow: 2px 2px 10px black;">PROFILE</h1>
  </section>

  <!-- MAIN CONTENT -->
  <div class="container-fluid mt-4">
    <div class="row">

     <!-- MOBILE SETTINGS TOP BAR -->
      <div class="mobile-settings-bar d-md-none">
        <span class="mobile-settings-title">SETTINGS</span>

        <button class="mobile-hamburger-btn" onclick="toggleDropdown()">
          <i class="material-icons">&#xe8b8;</i>
        </button>
      </div>
      <!-- DROPDOWN MENU (MOBILE) -->
      <div id="mobileDropdown" class="mobile-dropdown d-md-none">
        <a href="/orders"><i class="fas fa-shopping-cart"></i> Orders</a>
        <a href="/profile"><i class="fas fa-user"></i> Personal Info</a>
        <a href="/addresses"><i class="fas fa-map-marker-alt"></i> Addresses</a>
        <a href="/wallet"><i class="fas fa-wallet"></i> Wallet</a>
      </div>

      <!-- NORMAL SIDEBAR (DESKTOP) -->
      <div class="col-md-2 sidebar d-none d-md-block">
        <h5>SETTINGS</h5>
        <a href="/orders"><i class="fas fa-shopping-cart"></i> Orders</a>
        <a href="/profile"><i class="fas fa-user"></i> Personal Info</a>
        <a href="/addresses"><i class="fas fa-map-marker-alt"></i> Addresses</a>
        <a href="/wallet"><i class="fas fa-wallet"></i> Wallet</a>
      </div>
      <!-- PROFILE FORM -->
      <div class="col-md-10 col-lg-9">
        <div class="profile-container">

          <div><h5 class="mb-4 page-title" style="font-size: 26px; padding-left: 0;">Basic Information</h5></div>

          <!-- PROFILE PICTURE -->
          <div class="profile-pic-wrapper">
            <img src="<%= user.image && user.image.length > 0 ? user.image[0] : '/wallpaper/banner.png' %>"
              class="profile-picture" />

            <input type="file" id="profileImage" accept="image/*" class="d-none" onchange="handleImageUpload()">

            <button type="button" onclick="document.getElementById('profileImage').click()" class="btn-upload">
              <i class="fas fa-camera"></i> Change Photo
            </button>
          </div>

          <!-- EDIT FORM -->
          <form id="editProfileForm">

            <label class="form-label">First Name</label>
            <div id="Error2" class="Error-message"></div>
            <input type="text" class="form-control mb-3" id="firstName" value="<%= user.name %>">

            <label class="form-label">Last Name</label>
            <div id="Error3" class="Error-message"></div>
            <input type="text" class="form-control mb-3" id="lastName" value="<%= user.lastName %>">

            <label class="form-label">Phone</label>
            <div id="Error4" class="Error-message"></div>
            <input type="text" class="form-control mb-3" id="phone" value="<%= user.phone %>">

            <label class="form-label">Gender</label>
            <div id="Error5" class="Error-message"></div>

            <div>
              <input type="radio" name="gender" value="Male" <%= user.gender==='Male'?'checked':'' %>> Male
              <input type="radio" name="gender" value="Female" <%= user.gender==='Female'?'checked':'' %> class="ms-3"> Female
              <input type="radio" name="gender" value="Other" <%= user.gender==='Other'?'checked':'' %> class="ms-3"> Other
            </div>

            <!-- BUTTON BLOCK -->
            <div class="button-block">
              <button type="button" onclick="editProfile()" class="action-btn">Save Changes</button>
              <a href="/profile/change-email" class="action-btn">Change Email</a>
            </div>

          </form>

        </div>
      </div>
    </div>
  </div>

</main>
  <script>
    async function handleImageUpload() {
      const input = document.getElementById('profileImage');
      const file = input.files[0];
      if (!file) return;

      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
      if (!allowedTypes.includes(file.type)) {
        Swal.fire('Invalid File!', 'Please upload an image (jpg, jpeg, png only).', 'warning');
        input.value = '';
        return;
      }

      const formData = new FormData();
      formData.append('profileImage', file);

      try {
        const response = await fetch(`/profile/upload-profile-pic/<%= user._id %>`, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();

        if (data.success) {
          document.querySelector('.profile-picture').src = data.imagePath;
          Swal.fire('Success!', 'Profile picture updated successfully.', 'success');
        } else {
          Swal.fire('Error!', 'Failed to upload image.', 'error');
        }
      } catch (error) {
        Swal.fire('Error!', 'Something went wrong.', 'error');
      }
    }

    async function editProfile() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const gender = document.querySelector('input[name="gender"]:checked')?.value;

      const Error2 = document.getElementById("Error2");
      const Error3 = document.getElementById("Error3");
      const Error4 = document.getElementById("Error4");
      const Error5 = document.getElementById("Error5");

      Error2.style.display = 'none';
      Error3.style.display = 'none';
      Error4.style.display = 'none';
      Error5.style.display = 'none';

      if (!/^[A-Za-z\s]+$/.test(firstName) || firstName.length < 3) {
        Error2.style.display = 'block';
        Error2.innerHTML = 'FirstName should contain only alphabets and be at least 3 characters long.';
        return;
      }
      if (lastName) {
        if (!/^[A-Za-z\s]+$/.test(lastName) || lastName.length < 3) {
          Error3.style.display = 'block';
          Error3.innerHTML = 'LastName should contain only alphabets and be at least 3 characters long.';
          return;
        }
      }
      if (!/^\d{10}$/.test(phone) || /^(\d)\1{9}$/.test(phone)) {
        Error4.style.display = 'block';
        Error4.innerHTML = 'Phone number must be 10 digits and not all same digits.';
        return;
      }
      if (!gender) {
        Error5.style.display = 'block';
        Error5.innerHTML = 'Please select a gender.';
        return;
      }

      const formData = new FormData();
      formData.append('firstName', firstName);
      formData.append('lastName', lastName);
      formData.append('phone', phone);
      formData.append('gender', gender);

      try {
        const response = await axios.post('/profile/edit', formData, {
          headers: {
            'Content-Type': 'multipart/form-data'
          }
        });

        if (response.data.success) {
          Swal.fire('Profile updated successfully!', '', 'success').then(() => {
            window.location.href = '/profile';
          });
        } else {
          Swal.fire('Failed to update profile!', response.data.message || '', 'error');
        }
      } catch (err) {
        console.error(err);
        Swal.fire('Something went wrong!', '', 'error');
      }
    }
    function toggleDropdown() {
      const drop = document.getElementById("mobileDropdown");
      drop.style.display = drop.style.display === "flex" ? "none" : "flex";
    }
  </script>

  <%- include("../../views/partials/userPartial/footer") %>
    <!-- MOBILE OFFCANVAS SIDEBAR -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">SETTINGS</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>

      <div class="offcanvas-body">
        <a href="/orders" class="d-block mb-3">
          <i class="fas fa-shopping-cart"></i> Orders
        </a>
        <a href="/profile" class="d-block mb-3">
          <i class="fas fa-user"></i> Personal Info
        </a>
        <a href="/addresses" class="d-block mb-3">
          <i class="fas fa-map-marker-alt"></i> Addresses
        </a>
        <a href="/wallet" class="d-block mb-3">
          <i class="fas fa-wallet"></i> Wallet
        </a>
      </div>
    </div>